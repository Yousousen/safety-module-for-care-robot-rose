import ISafetyCheck.dzn;
import DataTypes.dzn;
import LEDControl.dzn;

interface IController {
	in void initialise();
	in void destruct();
	in void reset();
	in UnsafeTriggered do_checks();

	behaviour {
		enum State {Idle, Operating};
		State state = State.Idle;

		[state.Idle] {
			on initialise: { state = State.Operating; }
			on destruct: illegal;
			on reset: illegal;
			on do_checks: illegal;
		}
		[state.Operating] {
			on initialise: illegal;
			on destruct: { state = State.Idle; }

			on reset: {}

			on do_checks: { reply(UnsafeTriggered.Yes); }
			on do_checks: { reply(UnsafeTriggered.No);  }
		}
	}
}

component Controller {
	provides IController iController;
	requires ILEDControl iLEDControl;
	requires ISafetyCheck iNext;

	behaviour {
		enum State {Idle, Operating};
		State systemState = State.Idle;
		bool unsafe_acknowledged = true;

		color_t red = $"0x3000"$;
		color_t blue = $"0x0006"$;
		

		[systemState.Idle] {
			on iController.initialise(): {
				iLEDControl.initialise_framebuffer();
				systemState = State.Operating;
			}
		}

		[systemState.Operating] {
			on iController.destruct(): {
				iLEDControl.destruct_framebuffer();
				systemState = State.Idle;
			}

			on iController.do_checks(): {
				Behavior safetyState = iNext.do_check();
				
				if (safetyState == Behavior.Unsafe) {
					// TODO: Remove parameter or rename event.
					iLEDControl.light_led_red(red);
					unsafe_acknowledged = false;
				} else if(unsafe_acknowledged) {
					iLEDControl.light_led_blue(blue);
				}
				if(!unsafe_acknowledged) {
					reply(UnsafeTriggered.Yes);
				}
				else {
					reply(UnsafeTriggered.No);
				}
			}
				
			// Unsafe behavior is acknowledged, reset state.
			on iController.reset(): {
				iLEDControl.reset_led();
				unsafe_acknowledged = true;
			}
		}
	}
}

requirement NoOverrideRequirement {
	on Controller;

	provides IController iController;
	requires ILEDControl iLEDControl;

	behaviour {
		bool unsafe_triggered;
		bool unsafe_acknowledged;

		on do_checks(): {
			if (unsafe_triggered) {
				iLEDControl.light_led_red();
				unsafe_acknowledged = false;
			// Can only override if unsafe is acknowledged.
			} else if (unsafe_acknowledged) {
				iLEDControl.light_led_blue();
				unsafe_triggered = false;
			}
			on reset(): {
				unsafe_acknowledged = true;
			}
		}
	}
}
}
